<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Zep Memory Chat</title>
  <style>
    :root {
      --bg-color: #0e0f12;
      --accent-color: #2563eb;
      --user-bubble: linear-gradient(135deg, #1f2937, #111318);
      --ai-bubble: linear-gradient(135deg, #0f172a, #111318);
      --glass-bg: rgba(255, 255, 255, 0.05);
      --glass-border: rgba(255, 255, 255, 0.08);
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      background: var(--bg-color);
      color: #e5e7eb;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      display: flex;
      flex-direction: column;
      height: 100vh;
    }
    header {
      padding: 16px 20px;
      border-bottom: 1px solid #1f2937;
      backdrop-filter: blur(8px);
      background: var(--glass-bg);
      position: sticky;
      top: 0;
      z-index: 10;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    header h1 {
      font-size: 18px;
      font-weight: 600;
      color: #f9fafb;
    }
    header button {
      background: none;
      border: none;
      color: #93a3b8;
      font-size: 14px;
      cursor: pointer;
      display: none;
    }
    .container {
      flex: 1;
      display: flex;
      overflow: hidden;
    }
    .chat {
      flex: 1;
      display: flex;
      flex-direction: column;
      padding: 20px;
      overflow-y: auto;
      scrollbar-width: thin;
    }
    .row {
      margin-bottom: 14px;
      display: flex;
      gap: 10px;
      animation: fadeIn 0.3s ease;
    }
    .bubble {
      padding: 12px 14px;
      border-radius: 16px;
      max-width: 75%;
      line-height: 1.35;
      white-space: pre-wrap;
      box-shadow: 0 4px 10px rgba(0,0,0,0.3);
      animation: slideUp 0.25s ease;
    }
    .user .bubble {
      background: var(--user-bubble);
      margin-left: auto;
    }
    .ai .bubble {
      background: var(--ai-bubble);
      border: 1px solid #1f2937;
    }
    .typing-indicator {
      display: flex;
      align-items: center;
      gap: 4px;
      color: #93a3b8;
      font-size: 13px;
      margin-bottom: 8px;
    }
    .typing-dot {
      width: 6px;
      height: 6px;
      background-color: #93a3b8;
      border-radius: 50%;
      animation: blink 1s infinite;
    }
    .typing-dot:nth-child(2) { animation-delay: 0.2s; }
    .typing-dot:nth-child(3) { animation-delay: 0.4s; }
    @keyframes blink {
      0%, 80%, 100% { opacity: 0.3; }
      40% { opacity: 1; }
    }
    .context-panel {
      width: 300px;
      background: var(--glass-bg);
      border-left: 1px solid var(--glass-border);
      padding: 16px;
      overflow-y: auto;
      font-size: 13px;
      color: #93a3b8;
      transition: transform 0.3s ease;
    }
    .context-panel h2 {
      font-size: 14px;
      margin-bottom: 8px;
      color: #e5e7eb;
    }
    .context-panel.updated {
      animation: flashUpdate 1s ease;
    }
    @keyframes flashUpdate {
      0% { background-color: rgba(37,99,235,0.2); }
      100% { background-color: transparent; }
    }
    form {
      display: flex;
      gap: 10px;
      padding: 14px 20px;
      border-top: 1px solid #1f2937;
      background: var(--glass-bg);
      backdrop-filter: blur(8px);
    }
    input[type="text"] {
      flex: 1;
      padding: 12px;
      border-radius: 8px;
      border: 1px solid #334155;
      background: #0f172a;
      color: #e5e7eb;
      font-size: 14px;
    }
    button {
      padding: 0 18px;
      border-radius: 8px;
      border: none;
      background: var(--accent-color);
      color: #fff;
      font-weight: 600;
      font-size: 14px;
      cursor: pointer;
      transition: background 0.2s ease;
    }
    button:hover { background: #1e4ecb; }
    button:disabled { opacity: 0.6; cursor: not-allowed; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    @keyframes slideUp { from { transform: translateY(8px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    @media (max-width: 768px) {
      .context-panel {
        position: fixed;
        top: 0;
        right: 0;
        height: 100%;
        transform: translateX(100%);
        z-index: 20;
      }
      .context-panel.open { transform: translateX(0); }
      header button { display: block; }
    }
  </style>
</head>
<body>
<header>
  <h1>Zep Memory Chat</h1>
  <button id="toggleContext">Context</button>
</header>
<div class="container">
  <div class="chat" id="chat"></div>
  <div class="context-panel" id="contextPanel" style="display:none">
    <h2>Zep Context</h2>
    <div id="contextText"></div>
  </div>
</div>
<form id="composer">
  <input id="msg" type="text" placeholder="Type your message..." autocomplete="off" />
  <button type="submit">Send</button>
</form>

<script>
let THREAD_ID = localStorage.getItem("zepThreadId") || null;
const chatEl = document.getElementById("chat");
const ctxPanel = document.getElementById("contextPanel");
const ctxText = document.getElementById("contextText");
const toggleBtn = document.getElementById("toggleContext");
const formEl = document.getElementById("composer");
const inputEl = document.getElementById("msg");

function addBubble(text, who) {
  const row = document.createElement("div");
  row.className = "row " + (who === "user" ? "user" : "ai");
  const bubble = document.createElement("div");
  bubble.className = "bubble";
  bubble.textContent = text;
  row.appendChild(bubble);
  chatEl.appendChild(row);
  chatEl.scrollTop = chatEl.scrollHeight;
}

function showTypingIndicator() {
  const row = document.createElement("div");
  row.className = "typing-indicator";
  row.id = "typingIndicator";
  row.innerHTML = '<div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div>';
  chatEl.appendChild(row);
  chatEl.scrollTop = chatEl.scrollHeight;
}

function removeTypingIndicator() {
  const el = document.getElementById("typingIndicator");
  if (el) el.remove();
}

async function startThread() {
  try {
    const res = await fetch("/api/start", { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({}) });
    if (!res.ok) {
      throw new Error(`HTTP error! status: ${res.status}`);
    }
    const data = await res.json();
    THREAD_ID = data.thread_id;
    localStorage.setItem("zepThreadId", THREAD_ID);
    console.log("Started new thread:", THREAD_ID);
  } catch (error) {
    console.error("Error starting thread:", error);
    throw error;
  }
}

async function sendMessage(text) {
  addBubble(text, "user");
  formEl.querySelector("button").disabled = true;
  showTypingIndicator();

  try {
    // Ensure we have a valid thread ID
    if (!THREAD_ID) {
      console.log("No thread ID, starting new thread...");
      await startThread();
    }

    console.log("Sending message with thread_id:", THREAD_ID);
    const res = await fetch("/api/message", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ thread_id: THREAD_ID, text })
    });
    
    removeTypingIndicator();
    formEl.querySelector("button").disabled = false;

    if (!res.ok) {
      const errorData = await res.json();
      console.error("Server error:", errorData);
      addBubble(`Error: ${errorData.error || 'Unknown error'}`, "ai");
      return;
    }

    const data = await res.json();
    addBubble(data.assistant, "ai");

    if (data.context && data.context.trim().length) {
      ctxPanel.style.display = "block";
      ctxText.textContent = data.context;
      ctxPanel.classList.add("updated");
      setTimeout(() => ctxPanel.classList.remove("updated"), 1000);
    }
  } catch (error) {
    removeTypingIndicator();
    formEl.querySelector("button").disabled = false;
    console.error("Error sending message:", error);
    addBubble("Network error. Please try again.", "ai");
  }
}

formEl.addEventListener("submit", async (e) => {
  e.preventDefault();
  const text = inputEl.value.trim();
  if (!text) return;
  inputEl.value = "";
  await sendMessage(text);
});

toggleBtn.addEventListener("click", () => {
  ctxPanel.classList.toggle("open");
});

(async () => {
  console.log("Initial THREAD_ID from localStorage:", THREAD_ID);
  
  if (!THREAD_ID || THREAD_ID === "null" || THREAD_ID === "undefined") {
    console.log("No valid thread ID, creating new thread...");
    localStorage.removeItem("zepThreadId"); // Clear invalid ID
    await startThread();
  } else {
    console.log("Using existing thread ID:", THREAD_ID);
    try {
      const res = await fetch(`/api/context?thread_id=${encodeURIComponent(THREAD_ID)}`);
      if (res.ok) {
        const data = await res.json();
        if (data.context && data.context.trim().length) {
          ctxPanel.style.display = "block";
          ctxText.textContent = data.context;
        }
        console.log("Loaded existing context for thread:", THREAD_ID);
      } else {
        console.log("Failed to load context, creating new thread...");
        await startThread();
      }
    } catch (error) {
      console.error("Error loading context:", error);
      console.log("Creating new thread due to error...");
      await startThread();
    }
  }
  
  console.log("Final THREAD_ID:", THREAD_ID);
})();
</script>
</body>
</html>